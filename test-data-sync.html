<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Data Sync - Bijak Sampah</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Data Sync - Bijak Sampah</h1>
    
    <div class="container">
        <h2>ðŸ“Š Status Data</h2>
        <div id="dataStatus" class="status info">Memeriksa data...</div>
        <div id="dataCount" class="data-display">Jumlah data: 0</div>
    </div>

    <div class="container">
        <h2>âž• Tambah Data Test</h2>
        <button class="button" onclick="addTestData()">Tambah Data Test</button>
        <button class="button" onclick="clearAllData()">Hapus Semua Data</button>
        <button class="button" onclick="refreshData()">Refresh Data</button>
    </div>

    <div class="container">
        <h2>ðŸ“‹ Data Tersimpan</h2>
        <div id="dataDisplay" class="data-display">Tidak ada data</div>
    </div>

    <div class="container">
        <h2>ðŸ”— Event Log</h2>
        <div id="eventLog" class="data-display">Event log akan muncul di sini...</div>
    </div>

    <script>
        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test page loaded');
            refreshData();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Listen untuk event wasteSaleAdded
            window.addEventListener('wasteSaleAdded', function(event) {
                logEvent('wasteSaleAdded', event.detail);
                refreshData();
            });

            // Listen untuk storage changes
            window.addEventListener('storage', function(event) {
                logEvent('storage', { key: event.key, newValue: event.newValue });
                if (event.key === 'wasteSalesData') {
                    refreshData();
                }
            });
        }

        // Function untuk menambah data test
        function addTestData() {
            const testData = {
                id: 'TEK' + Math.floor(Math.random() * 90000) + 10000,
                nasabah: 'Test User ' + Date.now(),
                jenisSampah: 'Plastik',
                judulPenawaran: 'Test Penawaran ' + Date.now(),
                deskripsi: 'Ini adalah data test untuk sinkronisasi',
                berat: Math.floor(Math.random() * 50) + 1,
                hargaPerKg: Math.floor(Math.random() * 5000) + 1000,
                totalHarga: 0,
                lokasi: 'Test Location',
                tanggal: new Date().toISOString(),
                status: 'Baru',
                isNew: true
            };

            // Hitung total harga
            testData.totalHarga = testData.berat * testData.hargaPerKg;

            // Ambil data existing
            const existingData = JSON.parse(localStorage.getItem('wasteSalesData') || '[]');
            
            // Tambah data baru
            existingData.push(testData);
            
            // Simpan ke localStorage
            localStorage.setItem('wasteSalesData', JSON.stringify(existingData));
            
            // Trigger event
            window.dispatchEvent(new CustomEvent('wasteSaleAdded', { detail: testData }));
            
            // Trigger storage event
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'wasteSalesData',
                newValue: JSON.stringify(existingData),
                oldValue: JSON.stringify(existingData.slice(0, -1))
            }));

            logEvent('Data ditambahkan', testData);
            refreshData();
        }

        // Function untuk menghapus semua data
        function clearAllData() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data?')) {
                localStorage.removeItem('wasteSalesData');
                logEvent('Data dihapus', 'Semua data berhasil dihapus');
                refreshData();
            }
        }

        // Function untuk refresh data
        function refreshData() {
            const data = JSON.parse(localStorage.getItem('wasteSalesData') || '[]');
            
            // Update status
            const statusDiv = document.getElementById('dataStatus');
            if (data.length === 0) {
                statusDiv.className = 'status info';
                statusDiv.textContent = 'Tidak ada data tersimpan';
            } else {
                statusDiv.className = 'status success';
                statusDiv.textContent = `Data tersimpan: ${data.length} item`;
            }

            // Update count
            document.getElementById('dataCount').textContent = `Jumlah data: ${data.length}`;

            // Update display
            const displayDiv = document.getElementById('dataDisplay');
            if (data.length === 0) {
                displayDiv.textContent = 'Tidak ada data';
            } else {
                displayDiv.textContent = JSON.stringify(data, null, 2);
            }
        }

        // Function untuk log event
        function logEvent(type, data) {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type}: ${JSON.stringify(data, null, 2)}\n\n`;
            
            logDiv.textContent = logEntry + logDiv.textContent;
            
            // Batasi log entries
            const lines = logDiv.textContent.split('\n');
            if (lines.length > 50) {
                logDiv.textContent = lines.slice(0, 50).join('\n');
            }
        }

        // Auto-refresh setiap 3 detik untuk testing
        setInterval(refreshData, 3000);
    </script>
</body>
</html>
